<div class="titulo-cuadro d-flex align-items-center m-2 mt-3">
    <img src="/productos.svg" alt="Productos" class="title-icon" />
    <span class="texto-titulo">Productos</span>
</div>

<app-resultados-buscar-registros (productoEditado)="actualizarProductoEditado($event)"
    (productoEliminado)="actualizarLista($event)"></app-resultados-buscar-registros>


<div class="container w-100">
    <div class="container-filter row g-3 align-items-center mb-3">

        <!-- Filtros + Botón -->
        <div class="d-flex justify-content-between align-items-center mt-4 flex-wrap">
            <!-- Filtros -->
            <app-filtros [registros]="registros" (registrosFiltrados)="actualizarRegistrosFiltrados($event)">
            </app-filtros>

            <!-- Botón -->
            <button class="btn btn-success fw-semibold" (click)="mostrarFormulario = true">
                Agregar Producto
            </button>
        </div>


        <!-- Tabla -->
        <app-tabla-base [datos]="registrosFiltrados" [columnas]="columnas" campoId="idProducto" [mostrarEditar]="true"
            [mostrarEliminar]="true" [botonExtra]="botonExtra" (editar)="onEditar($event)" (guardar)="onGuardar($event)"
            (cancelar)="onCancelar()" (eliminar)="onEliminar($event)" (botonExtraOutput)="onBotonExtra($event)">
        </app-tabla-base>

    </div>

    <!-- Modal Agregar Producto -->
    <div *ngIf="mostrarFormulario" class="modal-flotante">
        <div class="modal-contenido p-3 rounded-4">
            <button class="btn-close" (click)="mostrarFormulario = false"></button>
            <h2 class="text-center mb-4">Agregar Producto</h2>

            <form [formGroup]="productoForm" (ngSubmit)="agregarRegistro()">
                <div class="mb-2 text-start">
                    <label class="form-label fw-bold">Codigo Producto</label>
                    <input type="text" formControlName="idProducto" class="form-control" [disabled]="true"
                        placeholder="Se genera automaticamente." />
                </div>

                <div class="mb-2 text-start">
                    <label class="form-label fw-bold">Nombre</label>
                    <input type="text" formControlName="nombre" class="form-control" />
                </div>

                <div class="mb-2 text-start">
                    <label class="form-label fw-bold">Tipo</label>
                    <select formControlName="tipo" class="form-select" (change)="onTipoChangeAgregar()">
                        <option *ngFor="let t of tipos" [value]="t.valor">{{ t.nombre }}</option>
                    </select>
                </div>

                <div class="mb-2 text-start">
                    <label class="form-label fw-bold">Precio</label>
                    <input type="number" formControlName="precio" class="form-control" />
                </div>

                <div class="mb-2 text-start">
                    <label class="form-label fw-bold">Precio con Descuento</label>
                    <input type="number" formControlName="precioDescuento" class="form-control" />
                </div>

                <div class="mb-2 text-start">
                    <label class="form-label fw-bold">Cantidad</label>
                    <input type="number" formControlName="cantidad" class="form-control" />
                </div>

                <div class="mb-2 text-start">
                    <label class="form-label fw-bold">Imagen (opcional)</label>
                    <input type="file" (change)="onFileSelected($event)" accept="image/*" class="form-control" />
                </div>

                <button type="submit" class="btn btn-primary w-100 mt-3" [disabled]="!productoForm.valid">Guardar
                    Producto</button>
            </form>
        </div>
    </div>

    <!-- Modal subir imagen (para producto existente) -->
    <div *ngIf="formularioImagenVisible" class="modal-backdrop d-flex justify-content-center align-items-center">
        <div class="modal-content p-4 bg-white rounded shadow">
            <h5>Subir imagen para {{ productoSeleccionado?.nombre }}</h5>
            <input type="file" class="form-control my-2" (change)="onArchivoSeleccionado($event)" />
            <p *ngIf="nombreImagenSeleccionada">Archivo: {{ nombreImagenSeleccionada }}</p>
            <div class="d-flex justify-content-end gap-2 mt-3">
                <button class="btn btn-secondary" (click)="cerrarFormularioImagen()">Cancelar</button>
                <button class="btn btn-success" (click)="subirImagen()">Subir</button>
            </div>
        </div>
    </div>

    <!-- Vista de imagen -->
    <app-vista-imagen-producto [mostrar]="mostrarImagenProducto" [producto]="productoSeleccionado"
        (cerrar)="cerrarVistaImagen()" (vender)="venderProducto($event)">
    </app-vista-imagen-producto>
</div>