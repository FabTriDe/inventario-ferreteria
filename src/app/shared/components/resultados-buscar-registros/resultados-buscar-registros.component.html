<div class="container mt-5 mb-5">
    <!-- Barra de búsqueda -->
    <app-barra-busqueda (productosEncontrados)="recibirProductos($event)"></app-barra-busqueda>

    <!-- Mensaje productos encontrados -->
    <div class="row justify-content-center mt-4" *ngIf="productoEncontrado || mostrarTablaMultiple">
        <div class="col-md-10 d-flex align-items-center">
            <div class="flex-grow-1 text-center">
                <div class="alert alert-info fw-bold shadow-sm rounded-pill py-2 px-4 d-inline-block mb-0">
                    Productos Encontrados
                </div>
            </div>
            <button class="btn btn-dark btn-sm ms-3" (click)="cerrarTablaMultiple()">
                Cerrar tabla
            </button>
        </div>
    </div>

    <!-- TABLA PRODUCTO ÚNICO -->
    <div class="row justify-content-center mt-3 mb-4 table-responsive" *ngIf="productoEncontrado">
        <div class="col-md-12">
            <table class="table table-bordered text-center">
                <thead class="table-dark">
                    <tr>
                        <th>Codigo</th>
                        <th>Nombre</th>
                        <th>Tipo</th>
                        <th>Precio</th>
                        <th>Descuento</th>
                        <th>Sale a</th>
                        <th>Cantidad</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{{ productoEncontrado.idProducto }}</td>

                        <!-- Nombre -->
                        <td>
                            <input *ngIf="productoEncontrado.editando" [(ngModel)]="productoEncontrado.nombre"
                                class="form-control" />
                            <span *ngIf="!productoEncontrado.editando">
                                {{ productoEncontrado.nombre }}
                            </span>
                        </td>

                        <!-- Tipo -->
                        <td>
                            <select *ngIf="productoEncontrado.editando" [(ngModel)]="productoEncontrado.tipo"
                                class="form-select">
                                <option *ngFor="let tipo of tipos" [value]="tipo.valor">
                                    {{ tipo.nombre }}
                                </option>
                            </select>
                            <span *ngIf="!productoEncontrado.editando">
                                {{ productoEncontrado.tipo | titlecase }}
                            </span>
                        </td>

                        <!-- Precio -->
                        <td>
                            <input *ngIf="productoEncontrado.editando" [(ngModel)]="productoEncontrado.precio"
                                type="number" class="form-control" />
                            <span *ngIf="!productoEncontrado.editando">
                                ${{ productoEncontrado.precio | number:'1.0-0' }}
                            </span>
                        </td>

                        <!-- Precio Descuento -->
                        <td>
                            <input *ngIf="productoEncontrado.editando" [(ngModel)]="productoEncontrado.precioDescuento"
                                type="number" class="form-control" />
                            <span *ngIf="!productoEncontrado.editando">
                                {{
                                productoEncontrado.precioDescuento == null || productoEncontrado.precioDescuento === 0
                                ? 'N/A'
                                : ('$' + (productoEncontrado.precioDescuento | number:'1.0-0'))
                                }}
                            </span>
                        </td>

                        <td>
                            <input *ngIf="productoEncontrado.editando" [(ngModel)]="productoEncontrado.precioCompra"
                                type="number" class="form-control" />
                            <span *ngIf="!productoEncontrado.editando">
                                {{
                                productoEncontrado.precioCompra == null || productoEncontrado.precioCompra === 0
                                ? 'N/A'
                                : ('$' + (productoEncontrado.precioCompra | number:'1.0-2'))
                                }}
                            </span>
                        </td>

                        <!-- Cantidad -->
                        <td>
                            <input *ngIf="productoEncontrado.editando" [(ngModel)]="productoEncontrado.cantidad"
                                type="number" class="form-control" />
                            <span *ngIf="!productoEncontrado.editando">
                                {{ (productoEncontrado.cantidad || 0) | number:'1.0-2' }}
                            </span>
                        </td>

                        <!-- Acciones -->
                        <td>
                            <div class="d-flex justify-content-center gap-2 mt-2 mb-2">

                                <!-- MODO EDICIÓN -->
                                <div *ngIf="productoEncontrado.editando" class="d-flex gap-2">
                                    <button *ngIf="productoEncontrado.imagen" class="btn btn-info btn-sm"
                                        (click)="mostrarFormularioImagen(productoEncontrado)">
                                        <i class="bi bi-upload"></i> Cambiar Imagen
                                    </button>
                                    <button class="btn btn-success btn-sm" (click)="guardarEdicion()">
                                        <i class="bi bi-check2"></i> Guardar
                                    </button>
                                    <button class="btn btn-secondary btn-sm" (click)="cancelarEdicion()">
                                        <i class="bi bi-x-lg"></i> Cancelar
                                    </button>
                                </div>

                                <!-- MODO NORMAL -->
                                <div *ngIf="!productoEncontrado.editando" class="d-flex gap-2">
                                    <button *ngIf="!productoEncontrado.imagen" class="btn btn-info btn-sm"
                                        (click)="mostrarFormularioImagen(productoEncontrado)">
                                        <i class="bi bi-upload"></i> Subir Imagen
                                    </button>
                                    <button class="btn btn-secondary btn-sm"
                                        (click)="verImagenProducto(productoEncontrado)">
                                        <i class="bi bi-eye"></i> Ver
                                    </button>
                                    <button class="btn btn-dark btn-sm" (click)="venderProducto(productoEncontrado)">
                                        <i class="bi bi-cart"></i> Vender
                                    </button>
                                    <button class="btn btn-warning btn-sm" (click)="activarEdicion()">
                                        <i class="bi bi-pencil-square"></i> Editar
                                    </button>
                                    <button class="btn btn-danger btn-sm" (click)="eliminarProducto()">
                                        <i class="bi bi-trash3"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- TABLA PRODUCTOS MÚLTIPLES -->
    <div class="row justify-content-center mt-4 mb-4" *ngIf="mostrarTablaMultiple">
        <div class="col-md-12">
            <table class="table table-striped table-bordered text-center">
                <thead class="table-dark">
                    <tr>
                        <th>Codigo</th>
                        <th>Nombre</th>
                        <th>Tipo</th>
                        <th>Precio</th>
                        <th>Descuento</th>
                        <th>Sale a</th>
                        <th>Cantidad</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let producto of productos">
                        <td>{{ producto.idProducto }}</td>

                        <!-- Nombre -->
                        <td>
                            <input *ngIf="producto.editando" [(ngModel)]="producto.nombre" class="form-control" />
                            <span *ngIf="!producto.editando">
                                {{ producto.nombre }}
                            </span>
                        </td>

                        <!-- Tipo -->
                        <td>
                            <select *ngIf="producto.editando" [(ngModel)]="producto.tipo" class="form-select">
                                <option *ngFor="let tipo of tipos" [value]="tipo.valor">
                                    {{ tipo.nombre }}
                                </option>
                            </select>
                            <span *ngIf="!producto.editando">
                                {{ producto.tipo | titlecase }}
                            </span>
                        </td>

                        <!-- Precio -->
                        <td>
                            <input *ngIf="producto.editando" [(ngModel)]="producto.precio" type="number"
                                class="form-control" />
                            <span *ngIf="!producto.editando">
                                ${{ producto.precio | number:'1.0-0' }}
                            </span>
                        </td>

                        <!-- Precio Descuento -->
                        <td>
                            <input *ngIf="producto.editando" [(ngModel)]="producto.precioDescuento" type="number"
                                class="form-control" />
                            <span *ngIf="!producto.editando">
                                {{
                                producto.precioDescuento == null || producto.precioDescuento === 0
                                ? 'N/A'
                                : ('$' + (producto.precioDescuento | number:'1.0-0'))
                                }}
                            </span>
                        </td>

                        <td>
                            <input *ngIf="producto.editando" [(ngModel)]="producto.precioCompra" type="number"
                                class="form-control" />
                            <span *ngIf="!producto.editando">
                                {{
                                producto.precioCompra == null || producto.precioCompra === 0
                                ? 'N/A'
                                : ('$' + (producto.precioCompra | number:'1.0-2'))
                                }}
                            </span>
                        </td>

                        <!-- Cantidad -->
                        <td>
                            <input *ngIf="producto.editando" [(ngModel)]="producto.cantidad" type="number"
                                class="form-control" />
                            <span *ngIf="!producto.editando">
                                {{ (producto.cantidad || 0) | number:'1.0-2' }}
                            </span>
                        </td>

                        <!-- Acciones -->
                        <td>
                            <div class="d-flex justify-content-center gap-2 mt-2 mb-2">

                                <!-- MODO EDICIÓN -->
                                <div *ngIf="producto.editando" class="d-flex gap-2">
                                    <button *ngIf="producto.imagen" class="btn btn-info btn-sm"
                                        (click)="mostrarFormularioImagen(producto)">
                                        <i class="bi bi-upload"></i> Cambiar Imagen
                                    </button>
                                    <button class="btn btn-success btn-sm" (click)="guardarEdicion(producto)">
                                        <i class="bi bi-check2"></i> Guardar
                                    </button>
                                    <button class="btn btn-secondary btn-sm" (click)="cancelarEdicion(producto)">
                                        <i class="bi bi-x-lg"></i> Cancelar
                                    </button>
                                </div>

                                <!-- MODO NORMAL -->
                                <div *ngIf="!producto.editando" class="d-flex gap-2">
                                    <button *ngIf="!producto.imagen" class="btn btn-info btn-sm"
                                        (click)="mostrarFormularioImagen(producto)">
                                        <i class="bi bi-upload"></i> Subir Imagen
                                    </button>
                                    <button class="btn btn-secondary btn-sm" (click)="verImagenProducto(producto)">
                                        <i class="bi bi-eye"></i> Ver
                                    </button>
                                    <button class="btn btn-dark btn-sm" (click)="venderProducto(producto)">
                                        <i class="bi bi-cart"></i> Vender
                                    </button>
                                    <button class="btn btn-warning btn-sm" (click)="activarEdicion(producto)">
                                        <i class="bi bi-pencil-square"></i> Editar
                                    </button>
                                    <button class="btn btn-danger btn-sm" (click)="eliminarProducto(producto)">
                                        <i class="bi bi-trash3"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- MODAL SUBIR IMAGEN -->
    <div *ngIf="formularioImagenVisible" class="modal-flotante">
        <div class="modal-contenido p-4 rounded-4 position-relative">
            <button class="btn-close position-absolute top-0 end-0 m-3" (click)="cerrarFormularioImagen()">
            </button>

            <h4 class="text-center mb-4">
                Subir Imagen para: {{ productoSeleccionado?.nombre }}
            </h4>

            <div class="form-group mb-3">
                <label class="form-label fw-bold">Seleccionar imagen</label>
                <input type="file" class="form-control" (change)="onArchivoSeleccionado($event)" accept="image/*" />
            </div>

            <div class="form-text mb-3 text-center" *ngIf="nombreImagenSeleccionada">
                Imagen seleccionada: <strong>{{ nombreImagenSeleccionada }}</strong>
            </div>

            <div class="d-flex justify-content-center gap-3 mt-4">
                <button class="btn btn-secondary" (click)="cerrarFormularioImagen()">
                    Cancelar
                </button>
                <button class="btn btn-primary" (click)="subirImagen()">
                    Subir Imagen
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL VER IMAGEN -->
    <app-vista-imagen-producto [mostrar]="mostrarImagenProducto" [producto]="productoSeleccionado"
        (cerrar)="cerrarVistaImagen()" (vender)="venderProducto($event)">
    </app-vista-imagen-producto>

    <!-- MODAL VENTAS -->
    <app-modal-ventas [producto]="productoParaVender" (cerrar)="productoParaVender = null"
        (ventaConfirmada)="productoEditado.emit($event.producto)">
    </app-modal-ventas>
</div>